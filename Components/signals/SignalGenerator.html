
import React, { useState } from "react";
import { Signal } from "@/entities/Signal";
import { InvokeLLM } from "@/integrations/Core";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Zap, Loader2, TrendingUp } from "lucide-react";
import { motion } from "framer-motion";

export default function SignalGenerator({ onSignalsGenerated }) {
  const [isGenerating, setIsGenerating] = useState(false);
  const [lastGenerated, setLastGenerated] = useState(null);

  const generateSignals = async () => {
    setIsGenerating(true);
    try {
      const prompt = `You are an expert forex trading analyst. Generate 5-8 high-quality forex trading signals for today.

Consider current market conditions, technical analysis, and fundamental factors. For each signal provide:
- Currency pair (major pairs like EUR/USD, GBP/USD, USD/JPY, AUD/USD, USD/CAD, EUR/GBP, GBP/JPY)
- Signal type (BUY or SELL)
- Entry price (realistic current market price)
- Take profit level
- Stop loss level
- Confidence score (1-10, be conservative)
- Time frame (5M, 15M, 1H, 4H, or 1D)
- Risk to reward ratio
- Potential pips profit
- Brief analysis explaining the reasoning

Make the signals diverse across different currency pairs and timeframes. Use realistic market prices and proper risk management.`;

      const response = await InvokeLLM({
        prompt,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            signals: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  currency_pair: { type: "string" },
                  signal_type: { type: "string", enum: ["BUY", "SELL"] },
                  entry_price: { type: "number" },
                  take_profit: { type: "number" },
                  stop_loss: { type: "number" },
                  confidence: { type: "number", minimum: 1, maximum: 10 },
                  analysis: { type: "string" },
                  time_frame: { type: "string", enum: ["5M", "15M", "1H", "4H", "1D"] },
                  risk_reward: { type: "number" },
                  pips_potential: { type: "number" }
                }
              }
            }
          }
        }
      });

      if (response.signals && response.signals.length > 0) {
        // Bulk create signals
        await Signal.bulkCreate(response.signals);
        setLastGenerated(new Date());
        onSignalsGenerated();
      }
    } catch (error) {
      console.error("Error generating signals:", error);
    }
    setIsGenerating(false);
  };

  return (
    <Card className="bg-gradient-to-br from-gray-800 to-gray-900 border-gray-700">
      <CardHeader>
        <CardTitle className="flex items-center gap-3 text-white">
          <div className="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
            <Zap className="w-6 h-6 text-white" />
          </div>
          Signal Generator
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <div className="text-sm text-gray-400">
          Generate fresh forex signals using advanced analysis of current market conditions.
        </div>
        
        {lastGenerated && (
          <div className="text-sm text-green-400">
            Last generated: {lastGenerated.toLocaleTimeString()}
          </div>
        )}
        
        <Button
          onClick={generateSignals}
          disabled={isGenerating}
          className="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold"
          size="lg"
        >
          {isGenerating ? (
            <>
              <Loader2 className="w-5 h-5 mr-2 animate-spin" />
              Generating Signals...
            </>
          ) : (
            <>
              <TrendingUp className="w-5 h-5 mr-2" />
              Generate New Signals
            </>
          )}
        </Button>
      </CardContent>
    </Card>
  );
}
