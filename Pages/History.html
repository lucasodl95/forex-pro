import React, { useState, useEffect } from "react";
import { Signal } from "@/entities/Signal";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { CalendarDays, TrendingUp, TrendingDown, Clock } from "lucide-react";
import { format } from "date-fns";

export default function History() {
  const [signals, setSignals] = useState([]);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    loadSignals();
  }, []);

  const loadSignals = async () => {
    const data = await Signal.list("-created_date", 100);
    setSignals(data);
    setIsLoading(false);
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'HIT_TP': return 'bg-green-500/20 text-green-400 border-green-500/30';
      case 'HIT_SL': return 'bg-red-500/20 text-red-400 border-red-500/30';
      case 'ACTIVE': return 'bg-blue-500/20 text-blue-400 border-blue-500/30';
      case 'EXPIRED': return 'bg-gray-500/20 text-gray-400 border-gray-500/30';
      default: return 'bg-gray-500/20 text-gray-400 border-gray-500/30';
    }
  };

  const filterByStatus = (status) => {
    if (status === 'all') return signals;
    return signals.filter(signal => signal.status === status);
  };

  return (
    <div className="min-h-screen bg-gray-900 p-4 md:p-8">
      <div className="max-w-7xl mx-auto">
        <div className="flex items-center gap-3 mb-8">
          <CalendarDays className="w-8 h-8 text-purple-400" />
          <div>
            <h1 className="text-3xl font-bold text-white">Signal History</h1>
            <p className="text-gray-400">Complete record of all generated signals</p>
          </div>
        </div>

        <Tabs defaultValue="all" className="space-y-6">
          <TabsList className="bg-gray-800 border-gray-700">
            <TabsTrigger value="all" className="data-[state=active]:bg-gray-700">All Signals</TabsTrigger>
            <TabsTrigger value="ACTIVE" className="data-[state=active]:bg-gray-700">Active</TabsTrigger>
            <TabsTrigger value="HIT_TP" className="data-[state=active]:bg-gray-700">Hit TP</TabsTrigger>
            <TabsTrigger value="HIT_SL" className="data-[state=active]:bg-gray-700">Hit SL</TabsTrigger>
            <TabsTrigger value="EXPIRED" className="data-[state=active]:bg-gray-700">Expired</TabsTrigger>
          </TabsList>

          {['all', 'ACTIVE', 'HIT_TP', 'HIT_SL', 'EXPIRED'].map((status) => (
            <TabsContent key={status} value={status} className="space-y-4">
              {isLoading ? (
                <div className="space-y-4">
                  {Array(5).fill(0).map((_, i) => (
                    <div key={i} className="animate-pulse">
                      <div className="h-32 bg-gray-800 rounded-lg"></div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="space-y-4">
                  {filterByStatus(status).map((signal) => (
                    <Card key={signal.id} className="bg-gray-800/50 border-gray-700 hover:bg-gray-800/70 transition-all duration-300">
                      <CardHeader className="pb-3">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-4">
                            {signal.signal_type === 'BUY' ? (
                              <TrendingUp className="w-6 h-6 text-green-400" />
                            ) : (
                              <TrendingDown className="w-6 h-6 text-red-400" />
                            )}
                            <div>
                              <CardTitle className="text-xl text-white">{signal.currency_pair}</CardTitle>
                              <div className="flex items-center gap-2 mt-1">
                                <Badge className={`${signal.signal_type === 'BUY' ? 'bg-green-500/20 text-green-400 border-green-500/30' : 'bg-red-500/20 text-red-400 border-red-500/30'} border`}>
                                  {signal.signal_type}
                                </Badge>
                                <Badge variant="outline" className={getStatusColor(signal.status)}>
                                  {signal.status}
                                </Badge>
                              </div>
                            </div>
                          </div>
                          <div className="text-right">
                            <div className="flex items-center gap-2 text-gray-400 mb-1">
                              <Clock className="w-4 h-4" />
                              <span className="text-sm">{format(new Date(signal.created_date), 'MMM d, HH:mm')}</span>
                            </div>
                            <div className="text-sm text-gray-400">
                              Confidence: <span className="text-white font-semibold">{signal.confidence}/10</span>
                            </div>
                          </div>
                        </div>
                      </CardHeader>
                      
                      <CardContent>
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
                          <div>
                            <span className="text-sm text-gray-400">Entry</span>
                            <p className="font-mono text-white font-semibold">{signal.entry_price}</p>
                          </div>
                          <div>
                            <span className="text-sm text-gray-400">Take Profit</span>
                            <p className="font-mono text-green-400 font-semibold">{signal.take_profit}</p>
                          </div>
                          <div>
                            <span className="text-sm text-gray-400">Stop Loss</span>
                            <p className="font-mono text-red-400 font-semibold">{signal.stop_loss}</p>
                          </div>
                          <div>
                            <span className="text-sm text-gray-400">R:R</span>
                            <p className="font-mono text-yellow-400 font-semibold">1:{signal.risk_reward}</p>
                          </div>
                          <div>
                            <span className="text-sm text-gray-400">Pips</span>
                            <p className="font-mono text-blue-400 font-semibold">+{signal.pips_potential}</p>
                          </div>
                        </div>
                        
                        {signal.analysis && (
                          <div className="pt-3 border-t border-gray-700">
                            <p className="text-sm text-gray-300">{signal.analysis}</p>
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  ))}
                </div>
              )}
            </TabsContent>
          ))}
        </Tabs>
      </div>
    </div>
  );
}